<VirtualHost *:443>
    ServerName sharefast.zip
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/apache2/ssl/sharefast.zip.crt
    SSLCertificateKeyFile /etc/apache2/ssl/sharefast.zip.key

    # Security Headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
    Header always set X-XSS-Protection "1; mode=block"

    ErrorLog ${APACHE_LOG_DIR}/ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/ssl-access.log combined

    # Deny all by default, but allow root index.html
    <Directory /var/www/html>
        Options -Indexes -FollowSymLinks
        AllowOverride None
        DirectoryIndex index.html
        Require all denied
    </Directory>
    
    # Allow root index.html to be served
    <LocationMatch "^/$">
        Require all granted
    </LocationMatch>
    
    <LocationMatch "^/index\.html$">
        Require all granted
    </LocationMatch>
    
    # Allow /dist/ directory (for downloads)
    <Directory /var/www/html/dist>
        Options -Indexes
        AllowOverride None
        Require all granted
    </Directory>

    # Allow public access to /server/ directory (website files)
    <Directory /var/www/html/server>
        Options -Indexes -FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # Allow public access to /server/dist/ directory (downloads)
    <Directory /var/www/html/server/dist>
        Options -Indexes
        AllowOverride None
        Require all granted
    </Directory>

    # Allow public access to /server/api/ directory (API endpoints)
    # API must be public for desktop app to work, but we secure it with:
    # - Rate limiting (prevents abuse)
    # - Input validation (in PHP)
    # - Session-based authentication (code + session_id)
    <Directory /var/www/html/server/api>
        Options -Indexes
        AllowOverride All
        Require all granted
        
        # Rate limiting (if mod_ratelimit is available)
        <IfModule mod_ratelimit.c>
            # Limit to 100 requests per minute per IP
            RLimitRequests 100
            RLimitInterval 60
        </IfModule>
    </Directory>

    # Explicitly deny access to storage and other sensitive directories
    <Directory /var/www/html/storage>
        Require all denied
    </Directory>

    <Directory /var/www/html/server/storage>
        Require all denied
    </Directory>
</VirtualHost>

# HTTP (port 80) - Only allow root index.html, redirect everything else to HTTPS
<VirtualHost *:80>
    ServerName sharefast.zip
    
    # Deny all by default
    <Directory /var/www/html>
        Require all denied
    </Directory>
    
    # Allow only root index.html via HTTP
    <LocationMatch "^/$">
        <Limit GET>
            Require all granted
        </Limit>
    </LocationMatch>
    
    <LocationMatch "^/index\.html$">
        <Limit GET>
            Require all granted
        </Limit>
    </LocationMatch>
    
    # Allow /server/index.html via HTTP
    <LocationMatch "^/server/index\.html$">
        <Limit GET>
            Require all granted
        </Limit>
    </LocationMatch>
    
    # Redirect everything else to HTTPS
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/index\.html$ [NC]
    RewriteCond %{REQUEST_URI} !^/server/index\.html$ [NC]
    RewriteCond %{REQUEST_URI} !^/$ [NC]
    RewriteRule ^(.*)$ https://sharefast.zip%{REQUEST_URI} [R=301,L]
    
    ErrorLog ${APACHE_LOG_DIR}/http-error.log
    CustomLog ${APACHE_LOG_DIR}/http-access.log combined
</VirtualHost>
